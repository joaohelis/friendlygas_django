{% extends "core/base.html" %}

{% block content %}

<script>
    $(document).ready(function(){

        var MY_LOCALIZATION = "Minha Localização"

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition)
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function nearGasStations(position, map) {
            $.ajax({
                url: '{% url "core:near_gas_stations" %}',
                data: {
                  'latitude': position.coords.latitude,
                  'longitude': position.coords.longitude,
                  'radius': 1500
                },
                dataType: 'json',
                success: function (data) {
                    window.data = data

                    $.each(data, function(key, value){                        
                        var position = value.position.split(",").map(function (x) { return parseFloat(x); });
                        var uluru = {lat: position[0], lng: position[1]};
                        value.position = uluru;
                        createMarker(value, map)
                    });                   
                },
                error: function(data){
                    console.log(data);
                }
            });                 
        }         
        
        function showPosition(position) {
            var uluru = {lat: position.coords.latitude, lng: position.coords.longitude};
            var map = new google.maps.Map(document.getElementById('gMapsDiv'), {
                zoom: 15,
                center: uluru
            });
            
            marker_info = {
                name: MY_LOCALIZATION,
                position: uluru
            }

            createMarker(marker_info, map);
            nearGasStations(position, map);
            createCircle(uluru, map)
        }
        
        function createMarker(marker_info, map) {
            console.log(marker_info)

            var starsMedia = calculateStarsMedia(marker_info.star_votes)
            var contentString = `<div id="infoWindow">
                <p><span class="font-weight-bold">{0}</span></p>
                <p><span class="font-weight-bold">Preço:</span>R$ {1}</p>
                <p class="stars-font-size">
                <i class="fa fa-star customStar"></i>
                <i class="fa fa-star customStar"></i> 
                <i class="fa fa-star customStar"></i> 
                <i class="fa fa-star-half-o customStar"></i> 
                <i class="fa fa-star-o customStar"></i> 
                </p> 
                </div>
                </div>`;


            var contentString, infowindow
            if (marker_info.name != MY_LOCALIZATION) {
                contentString = '<div id="infoWindow">'+
                '<div>'+
                '<p><span class="font-weight-bold">' + marker_info.name + '</span></p>' +
                '<p><span class="font-weight-bold">Preço:</span> R$ ' + marker_info.price + '</p>' +
                '<p class="stars-font-size">'

                for (i = 0; i < Math.floor(starsMedia); i++) {
                    contentString += '<i class="fa fa-star"></i>'
                }

                for (i = 0; i < 5 - Math.floor(starsMedia); i++) {
                   contentString += '<i class="fa fa-star-o"></i>'
                }

                contentString += ' (' + starsMedia +') </p> </div> </div>';

                infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
            }

            var icon
            if (marker_info.name != MY_LOCALIZATION) {
                icon = "http://maps.google.com/mapfiles/kml/shapes/gas_stations.png"            
            }

            var marker = new google.maps.Marker({
                position: marker_info.position,
                map: map,
                icon: icon,
                map_icon_label: '<span class="map-icon map-icon-gas-station"></span>'
            });

            if (marker_info.name != MY_LOCALIZATION) {
                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
            }
        }
        
        function createCircle(position, map) {
            var cityCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.5,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.20,
                map: map,
                center: position,
                radius: 1500
            });
        }

        function calculateStarsMedia(star_votes) {
            var peso = 0
            var somaVotos = 0
            var media
            $.each(star_votes, function(key, value){
                peso = peso + (key * parseInt(value))
                somaVotos = somaVotos + parseInt(value)
            });
            media = parseFloat(peso / somaVotos).toFixed(2)
            return media
        }
               

        getLocation()
    })
</script>

<div id="gMapsDiv"></div>

{% endblock %}